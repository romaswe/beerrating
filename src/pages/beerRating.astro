---
import type { APIResponse, BeerObj, StyleObj } from "../interfaces/types";
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";

const title = "Beer rating";
const description = "Page about beer";

const spreadsheetId = import.meta.env.SPREADSHEET_ID;
const range = import.meta.env.RANGE;
const apiKey = import.meta.env.GOOGLE_SHEETS_API_KEY;

const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?key=${apiKey}`;

let data: string[][] = []; // Type data as a 2D array of strings
let headers: string[] = [];
let error: string | null = null;

let styleMap: Map<string, StyleObj> = new Map();

try {
  const response = await fetch(url);

  if (!response.ok) {
    throw new Error(`Error: ${response.status} ${response.statusText}`);
  }

  const result: APIResponse = await response.json();

  if (!result.values || result.values.length === 0) {
    throw new Error("Error: No data found in the Google Sheet.");
  }

  headers = result.values[0]; // The first row is the headers

  data = result.values.slice(1).filter((row) => row[0].trim() !== "");
  data = data.sort((a, b) => {
    const valueA = parseFloat(a[6]) || 0; // Parse as float, use 0 if empty or NaN
    const valueB = parseFloat(b[6]) || 0; // Parse as float, use 0 if empty or NaN

    return valueB - valueA; // Sort in descending order (largest first)
  });
  await getStats(data);
} catch (err) {
  error = (err as Error).message;
  console.error("Failed to fetch data:", err);
}

async function getStats(data: string[][]) {
  var dataIndex = 0;
  data.forEach((row) => {
    const name = row[0];
    const style = row[1];
    const avrageRating = row[6];
    var styleObj: StyleObj = {
      style: style,
      count: (styleMap.get(style)?.count ?? 0) + 1,
      topBeer: styleMap.get(style)?.topBeer,
    };

    // get the top (average) rated beer of each style
    const roundedRating = Math.round(Number(avrageRating) * 100) / 100;
    const beerObj: BeerObj = {
      name: name,
      rating: roundedRating,
      style: style,
    };
    const compareRating =
      Math.round((styleMap.get(style)?.topBeer?.rating ?? 0) * 100) / 100;

    if (compareRating <= beerObj.rating) {
      styleObj.topBeer = beerObj;
    }

    styleMap.set(style, styleObj);
    dataIndex++;
  });
  //console.log(styleMap);
  //Array.from(styleMap).map((mapArray) => console.log(mapArray));
}
---

<html lang="se">
  <head>
    <BaseHead title={title} description={description} />
    <style>
      /* Global Styles */
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      h1 {
        text-align: center;
        margin-top: 20px;
      }

      h2,
      h3 {
        margin: 5px 0;
      }

      p {
        margin: 5px 0;
      }

      /* Header styling */
      header {
        background-color: #007bff;
        color: white;
        padding: 10px;
        text-align: center;
      }

      /* Stats Section */
      .stats {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-around;
        margin: 20px;
      }

      .styleWrapper {
        flex: 1 1 300px;
        background-color: #f9f9f9;
        margin: 10px;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        position: relative; /* Make the wrapper a containing block for the buttons */
        min-height: 150px; /* Optional: set a minimum height to ensure enough space */
        display: flex;
        flex-direction: column;
        justify-content: flex-start; /* Align content at the top */
      }

      /* Buttons */
      .buttonSystembolaget,
      .buttonUntappd,
      .buttonRatebeer {
        display: inline-block;
        background-color: #007bff;
        color: white;
        border: none;
        padding: 4px 6px;
        text-decoration: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      .buttonSystembolaget:hover,
      .buttonUntappd:hover {
        background-color: #0056b3;
      }

      /* Ensure that h2 and h3 remain at the top */
      .styleWrapper h2,
      .styleWrapper h3 {
        margin-bottom: auto;
      }

      /* Table Styling */
      table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
      }

      th,
      td {
        padding: 10px;
        text-align: left;
        border: 1px solid #ddd;
      }

      th {
        background-color: #f2f2f2;
      }

      /* Flexbox layout inside beer row cells */
      .td-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .td-content > span {
        flex: 1;
      }

      .td-content > div {
        display: flex;
        gap: 10px;
      }

      /* Hide columns 3, 4, 5 when horizontal overflow is detected */
      body.overflow-detected table td:nth-child(3),
      body.overflow-detected table th:nth-child(3),
      body.overflow-detected table td:nth-child(4),
      body.overflow-detected table th:nth-child(4),
      body.overflow-detected table td:nth-child(5),
      body.overflow-detected table th:nth-child(5),
      body.overflow-detected table td:nth-child(6),
      body.overflow-detected table th:nth-child(6) {
        display: none;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        /* Stats Section */
        .stats {
          flex-direction: column;
          align-items: center;
        }

        .styleWrapper {
          width: 90%;
          margin-bottom: 20px;
        }

        /* Table adjustments */
        .td-content {
          flex-direction: column;
          align-items: flex-start;
        }

        .td-content > div {
          margin-top: 10px;
        }
      }
    </style>

    <script>
      function checkOverflow() {
        const body = document.body;
        const hasOverflow = body.scrollWidth > window.innerWidth;

        if (hasOverflow) {
          body.classList.add("overflow-detected");
        } else {
          body.classList.remove("overflow-detected");
        }
      }

      // Run on page load and window resize
      window.addEventListener("load", checkOverflow);
      window.addEventListener("resize", checkOverflow);
    </script>
  </head>
  <body>
    <Header />
    <main>
      <h1>Beer Ratings</h1>
      <div class="stats">
        {
          Array.from(styleMap).map((mapArray) => (
            <div class="styleWrapper">
              <h2>
                {mapArray[0]}: {mapArray[1].count}
              </h2>
              <h3>
                Top beer: {mapArray[1].topBeer?.name}{" "}
                {mapArray[1].topBeer?.rating}
              </h3>
              <p>
                {mapArray[1].topBeer?.name ? (
                  <>
                    <a
                      href={`https://www.systembolaget.se/sortiment/?q=${encodeURIComponent(mapArray[1].topBeer?.name)}`}
                      class="buttonSystembolaget"
                      target="_blank"
                      rel="noopener noreferrer"
                    >
                      Systembolaget
                    </a>
                    <a
                      href={`https://untappd.com/search?q=${encodeURIComponent(mapArray[1].topBeer?.name)}`}
                      class="buttonUntappd"
                      target="_blank"
                      rel="noopener noreferrer"
                    >
                      Untappd
                    </a>
                    <a
                      href={`https://www.ratebeer.com/search?beername=${encodeURIComponent(mapArray[1].topBeer?.name)}&tab=beer`}
                      class="buttonRatebeer"
                      target="_blank"
                      rel="noopener noreferrer"
                    >
                      Ratebeer
                    </a>
                  </>
                ) : (
                  <p>No top beer found</p>
                )}
              </p>
            </div>
          ))
        }
      </div>

      {
        error ? (
          <p style="color: red;">{error}</p>
        ) : (
          <table border="1">
            <thead>
              <tr>
                {headers.map((header) => (
                  <th>{header}</th>
                ))}
              </tr>
            </thead>
            <tbody>
              {data.slice(1).map((row) => (
                <tr>
                  <td>
                    <span>{row[0]}</span>
                    <div>
                      <a
                        href={`https://www.systembolaget.se/sortiment/?q=${encodeURIComponent(row[0])}`}
                        class="buttonSystembolaget"
                        target="_blank"
                        rel="noopener noreferrer"
                      >
                        Systembolaget
                      </a>
                      <a
                        href={`https://untappd.com/search?q=${encodeURIComponent(row[0])}`}
                        class="buttonUntappd"
                        target="_blank"
                        rel="noopener noreferrer"
                      >
                        Untappd
                      </a>
                      <a
                        href={`https://www.ratebeer.com/search?beername=${encodeURIComponent(row[0])}&tab=beer`}
                        class="buttonUntappd"
                        target="_blank"
                        rel="noopener noreferrer"
                      >
                        Ratebeer
                      </a>
                    </div>
                  </td>
                  {row.slice(1).map((cell) => (
                    <td>{cell || ""}</td>
                  ))}
                </tr>
              ))}
            </tbody>
          </table>
        )
      }
    </main>
    <Footer />
  </body>
</html>
