---
import type { APIResponse, BeerObj, StyleObj } from "../interfaces/types";
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";

const title = "Beer rating";
const description = "Page about beer";

const spreadsheetId = import.meta.env.SPREADSHEET_ID;
const range = import.meta.env.RANGE;
const apiKey = import.meta.env.GOOGLE_SHEETS_API_KEY;

const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?key=${apiKey}`;

let data: string[][] = []; // Type data as a 2D array of strings
let error: string | null = null;

let styleMap: Map<string, StyleObj> = new Map();

try {
  const response = await fetch(url);

  if (!response.ok) {
    throw new Error(`Error: ${response.status} ${response.statusText}`);
  }

  const result: APIResponse = await response.json();

  if (!result.values || result.values.length === 0) {
    throw new Error("Error: No data found in the Google Sheet.");
  }

  // Filter out rows where the first cell is empty
  data = result.values.filter((row) => row[0].trim() !== "");
  await getStats(data);
} catch (err) {
  error = (err as Error).message;
  console.error("Failed to fetch data:", err);
}

async function getStats(data: string[][]) {
  var dataIndex = 0;
  data.forEach((row) => {
    // We are skipping the first row becasue its the headers
    if (dataIndex >= 1) {
      const name = row[0];
      const style = row[1];
      const avrageRating = row[6];
      var styleObj: StyleObj = {
        style: style,
        count: (styleMap.get(style)?.count ?? 0) + 1,
        topBeer: styleMap.get(style)?.topBeer,
      };

      // get the top (average) rated beer of each style
      const roundedRating = Math.round(Number(avrageRating) * 100) / 100;
      const beerObj: BeerObj = {
        name: name,
        rating: roundedRating,
        style: style,
      };
      const compareRating =
        Math.round((styleMap.get(style)?.topBeer?.rating ?? 0) * 100) / 100;

      if (compareRating <= beerObj.rating) {
        styleObj.topBeer = beerObj;
      }

      styleMap.set(style, styleObj);
    }
    dataIndex++;
  });
  //console.log(styleMap);
  Array.from(styleMap).map((mapArray) => console.log(mapArray));
}
---

<html lang="se">
  <head>
    <BaseHead title={title} description={description} />
    <style>
      .stats {
        display: flex;
        flex-direction: row;
      }
      .statsdata {
        margin: auto;
      }
      a.buttonSystembolaget {
        padding: 1px 6px;
        border: 1px outset buttonborder;
        border-radius: 3px;
        color: #ffe32a;
        background-color: #1a6a54;
        text-decoration: none;
        margin: 1px;
      }
      a.buttonUntappd {
        padding: 1px 6px;
        border: 1px outset buttonborder;
        border-radius: 3px;
        color: black;
        background-color: #ffc000;
        text-decoration: none;
        margin: 1px;
      }
    </style>
  </head>
  <body>
    <Header />
    <h1>Beer Ratings</h1>
    <div class="stats">
      {
        Array.from(styleMap).map((mapArray) => (
          <div class="styleWrapper">
            <h2>
              {mapArray[0]}: {mapArray[1].count}
            </h2>
            <h3>
              Top beer {mapArray[1].topBeer?.name} {mapArray[1].topBeer?.rating}
            </h3>
            <p>
              {mapArray[1].topBeer?.name ? (<a
                href={`https://www.systembolaget.se/sortiment/?q=${encodeURIComponent(mapArray[1].topBeer?.name)}`}
                class="buttonSystembolaget"
                target="_blank"
                rel="noopener noreferrer"
              >
                Systembolaget
              </a>
              <a
                href={`https://untappd.com/search?q=${encodeURIComponent(mapArray[1].topBeer?.name)}`}
                class="buttonUntappd"
                target="_blank"
                rel="noopener noreferrer"
              >
                Untappd
              </a>): <p>No top beer found</p>}
            </p>
          </div>
        ))
      }
    </div>

    {
      error ? (
        <p style="color: red;">{error}</p>
      ) : (
        <table border="1">
          <thead>
            <tr>
              {data[0].map((header) => (
                <th>{header}</th>
              ))}
            </tr>
          </thead>
          <tbody>
            {data.slice(1).map((row) => (
              <tr>
                <td>
                  <span>{row[0]}</span>
                  <div>
                    <a
                      href={`https://www.systembolaget.se/sortiment/?q=${encodeURIComponent(row[0])}`}
                      class="buttonSystembolaget"
                      target="_blank"
                      rel="noopener noreferrer"
                    >
                      Systembolaget
                    </a>
                    <a
                      href={`https://untappd.com/search?q=${encodeURIComponent(row[0])}`}
                      class="buttonUntappd"
                      target="_blank"
                      rel="noopener noreferrer"
                    >
                      Untappd
                    </a>
                  </div>
                </td>
                {row.slice(1).map((cell) => (
                  <td>{cell || ""}</td>
                ))}
              </tr>
            ))}
          </tbody>
        </table>
      )
    }
  </body>
</html>
